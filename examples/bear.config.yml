name: acme-platform

languages:
  go:
    detection:
      files: [go.mod]
    steps:
      - name: Download modules
        run: go mod download
      - name: Vet
        run: go vet ./...
      - name: Test
        run: go test -race -cover ./...
      - name: Build
        run: go build -o dist/app .

  node:
    detection:
      files: [package.json]
    steps:
      - name: Install
        run: npm install --prefer-offline
      - name: Lint
        run: npm run lint --if-present
      - name: Test
        run: npm test --if-present
      - name: Build
        run: npm run build --if-present

  python:
    detection:
      files: [pyproject.toml, requirements.txt]
    steps:
      - name: Check Python
        run: python3 --version
      - name: Syntax Check
        run: python3 -m py_compile *.py
      - name: Test
        run: python3 -m pytest --tb=short 2>/dev/null || python3 -c "print('No pytest, skipping')"

targets:
  cloudrun:
    vars:
      REGION: europe-west1
      MEMORY: 512Mi
    steps:
      - name: Build
        run: docker build -t gcr.io/$PROJECT/$NAME:$VERSION .
      - name: Push
        run: docker push gcr.io/$PROJECT/$NAME:$VERSION
      - name: Deploy
        run: |
          gcloud run deploy $NAME \
            --image gcr.io/$PROJECT/$NAME:$VERSION \
            --region $REGION \
            --memory $MEMORY

  cloudrun-job:
    vars:
      REGION: europe-west1
    steps:
      - name: Build
        run: docker build -t gcr.io/$PROJECT/$NAME:$VERSION .
      - name: Push
        run: docker push gcr.io/$PROJECT/$NAME:$VERSION
      - name: Deploy
        run: gcloud run jobs deploy $NAME --image gcr.io/$PROJECT/$NAME:$VERSION --region $REGION

  lambda:
    steps:
      - name: Package
        run: zip -r dist.zip .
      - name: Deploy
        run: aws lambda update-function-code --function-name $NAME --zip-file fileb://dist.zip

  s3-static:
    steps:
      - name: Sync
        run: aws s3 sync ./dist s3://$BUCKET --delete
      - name: Invalidate
        run: aws cloudfront create-invalidation --distribution-id $CF_DIST --paths "/*"

  docker-local:
    vars:
      PORT: "8080"
    steps:
      - name: Build Image
        run: podman build -t $NAME:$VERSION .
      - name: Stop Existing
        run: podman stop $NAME 2>/dev/null || true
      - name: Remove Existing
        run: podman rm $NAME 2>/dev/null || true
      - name: Start Container
        run: podman run -d --name $NAME -p $PORT:8080 -e PORT=8080 $NAME:$VERSION
