name: acme-platform

languages:
  - name: go
    detection:
      files: [go.mod]
    validation:
      setup:
        - name: Download modules
          run: go mod download
      lint:
        - name: Vet
          run: go vet ./...
      test:
        - name: Test
          run: go test -race -cover ./...
      build:
        - name: Build
          run: go build -o dist/app .

  - name: node
    detection:
      files: [package.json]
    validation:
      setup:
        - name: Install
          run: npm ci
      lint:
        - name: Lint
          run: npm run lint
      test:
        - name: Test
          run: npm test
      build:
        - name: Build
          run: npm run build

  - name: python
    detection:
      files: [pyproject.toml, requirements.txt]
    validation:
      setup:
        - name: Install
          run: pip install -e ".[dev]"
      lint:
        - name: Ruff
          run: ruff check .
      test:
        - name: Test
          run: pytest

targets:
  - name: cloudrun
    defaults:
      REGION: europe-west1
      MEMORY: 512Mi
    deploy:
      - name: Build
        run: docker build -t gcr.io/$PROJECT/$NAME:$VERSION .
      - name: Push
        run: docker push gcr.io/$PROJECT/$NAME:$VERSION
      - name: Deploy
        run: |
          gcloud run deploy $NAME \
            --image gcr.io/$PROJECT/$NAME:$VERSION \
            --region $REGION \
            --memory $MEMORY

  - name: cloudrun-job
    defaults:
      REGION: europe-west1
    deploy:
      - name: Build
        run: docker build -t gcr.io/$PROJECT/$NAME:$VERSION .
      - name: Push
        run: docker push gcr.io/$PROJECT/$NAME:$VERSION
      - name: Deploy
        run: gcloud run jobs deploy $NAME --image gcr.io/$PROJECT/$NAME:$VERSION --region $REGION

  - name: lambda
    deploy:
      - name: Package
        run: zip -r dist.zip .
      - name: Deploy
        run: aws lambda update-function-code --function-name $NAME --zip-file fileb://dist.zip

  - name: s3-static
    deploy:
      - name: Sync
        run: aws s3 sync ./dist s3://$BUCKET --delete
      - name: Invalidate
        run: aws cloudfront create-invalidation --distribution-id $CF_DIST --paths "/*"

  - name: docker-local
    defaults:
      PORT: 8080
    deploy:
      - name: Build Image
        run: docker build -t $NAME:$VERSION .
      - name: Stop Existing
        run: docker stop $NAME 2>/dev/null || true
      - name: Remove Existing
        run: docker rm $NAME 2>/dev/null || true
      - name: Start Container
        run: docker run -d --name $NAME -p $PORT:$PORT $NAME:$VERSION

  - name: local-binary
    defaults:
      OUTPUT_DIR: ./dist
    deploy:
      - name: Create Output Dir
        run: mkdir -p $OUTPUT_DIR
      - name: Copy Binary
        run: cp dist/app $OUTPUT_DIR/$NAME
      - name: Show Result
        run: ls -la $OUTPUT_DIR/$NAME && echo "âœ… Deployed $NAME version $VERSION"
